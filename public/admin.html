<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>nursery sera — 注文管理</title>
  <style>
    /* 管理画面のコンパクト化と拡大表示 */
    body {
      font-family: sans-serif;
      margin: 40px 10px; /* 左右マージンを減らす */
      /* 画面いっぱいに大きく表示 (モバイル管理画面) */
      zoom: 1.5; 
      transform-origin: top left;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed; /* 列幅を固定しやすく */
    }
    /* テーブルヘッダ・セルのスタイル */
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px; /* パディングを減らす */
      text-align: left;
      font-size: 10px; /* フォントサイズを小さく */
      vertical-align: top;
      word-break: break-all; /* 単語の途中で改行 */
    }
    th {
      background: #eee;
    }
    
    /* 選択ボタンの高さ調整（約3倍） */
    select.ship-type {
      height: 3em; /* 高さを調整 */
      font-size: 10px;
      padding: 0 2px;
    }

    /* チェックボタンの大きさ調整（約2倍） */
    input[type="checkbox"].row-check {
      transform: scale(1.5); /* 1.5倍に拡大 */
      margin: 0;
    }

    button {
      margin: 10px 0;
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .controls {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 12px;
      align-items: center;
      margin: 8px 0 16px;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .cols-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 4px 14px;
      margin-top: 8px;
      max-height: 260px;
      overflow: auto;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }
    .muted {
      color: #666;
      font-size: 10px; /* フォントサイズを小さく */
    }
    .ship-preview {
      font-weight: bold;
    }
    
    /* 出荷予定日入力のズーム防止（font-size: 16px; 以上にする） */
    input[type="text"]#shipMmdd {
      padding: 6px 8px;
      font-size: 16px; 
      width: 60px;
    }

    /* データ表示用CSS */
    .ship-type-label {
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <h1>注文データ一覧</h1>

  <div class="controls">
    <div class="row">
      <button id="csvSelectedBtn">選択行をCSVダウンロード</button>
    </div>
    <div class="row">
      <button id="toNekoposBtn">選択行をネコポスに変換</button>

      <button id="shipYearBtn" title="クリックで年を変更">2025</button>
      <label>
        出荷予定日(MMDD)：<input type="text" id="shipMmdd" placeholder="例: 1225" maxlength="4" inputmode="numeric" pattern="[0-9]*">
      </label>
      <span>→ <span id="shipPreview" class="ship-preview">未設定</span></span>
    </div>

    <div class="row">
      <button id="csvAllBtn">一括CSVダウンロード</button>
    </div>
    <div class="row">
      <button id="toHatsubaraiBtn">選択行を発払いに変換</button>
      <span class="muted">
        ※発送種別:<br>
        A=ネコポス<br>
        0=発払い
      </span>
    </div>
  </div>

  <details id="colPicker">
    <summary>CSVに含める項目を選ぶ（サーバー定義と完全一致）</summary>
    <div id="colsContainer" class="cols-list"></div>
    <label style="display:block;margin-top:8px;">
      <input type="checkbox" id="checkAllCols"> すべて選択 / 解除
    </label>
  </details>

  <table id="ordersTable">
    <thead>
      <tr>
        <th></th> 
        <th>ID</th>
        <th>名前</th>
        <th>住所</th>
        <th>電話</th>
        <th>配達希望日</th>
        <th>配達希望時間</th>
        <th>出荷予定日</th>
        <th>登録日</th>
        <th>発送種別<br><span class="ship-type-label muted">A=ネコポス<br>0=発払い</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    // ===== パスワードガード =====
    (function(){
      const pass = sessionStorage.getItem('admin-pass') || prompt('パスワードを入力してください');
      if (pass !== 'kohakurira') {
        alert('不正アクセス検知：トップページに戻ります');
        location.href = '/';
      } else {
        sessionStorage.setItem('admin-pass', pass);
      }
    })();

    // ===== グローバル =====
    let ORDERS = [];
    let CSV_HEADERS = [];
    let shipYear = new Date().getFullYear(); // 今年を初期値
    let shipMmdd = "";                       // "MMDD" 4桁（例: "1225"）

    // ===== 出荷予定日ユーティリティ =====
    function mmddToYmd(year, mmdd){
      const m = (mmdd || "").trim();
      if (!/^\d{4}$/g.test(m)) return "";
      const mm = m.slice(0,2);
      const dd = m.slice(2,4);
      const dt = new Date(`${year}/${mm}/${dd}`);
      if (isNaN(dt.getTime())) return "";
      const y = dt.getFullYear();
      const M = String(dt.getMonth()+1).padStart(2,"0");
      const D = String(dt.getDate()).padStart(2,"0");
      return `${y}/${M}/${D}`; // ヤマト向け
    }
    function getShipDateYmd(){
      return mmddToYmd(shipYear, shipMmdd);
    }
    function refreshShipPreview(){
      document.getElementById('shipYearBtn').textContent = String(shipYear);
      const ymd = getShipDateYmd();
      document.getElementById('shipPreview').textContent = ymd || "未設定";
      // テーブルの「出荷予定日」列を一括更新（見やすさ用）
      document.querySelectorAll('td[data-col="ship"]').forEach(td=>{
        const [y, m, d] = (ymd || "-").split('/');
        // YYYY/MM/DD → YYYY<br>MM/DD の2行表示
        td.innerHTML = ymd ? `${y}<br>${m}/${d}` : "-";
      });
    }

    // ===== CSVヘッダ取得 (変更なし) =====
    async function loadCsvHeaders() {
      const res = await fetch('/api/orders/csv/headers');
      if (!res.ok) throw new Error('CSVヘッダ取得に失敗');
      CSV_HEADERS = await res.json();
      const box = document.querySelector('#colsContainer');
      box.innerHTML = '';
      CSV_HEADERS.forEach(h => {
        const id = `col-${h.id}`;
        const div = document.createElement('label');
        div.innerHTML = `<input type="checkbox" id="${id}" data-id="${h.id}" checked> ${h.title} <span class="muted">(${h.id})</span>`;
        box.appendChild(div);
      });
      document.getElementById('checkAllCols').addEventListener('change', e=>{
        const checked = e.target.checked;
        box.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = checked);
      });
    }

    // ===== データ整形関数 =====

    // 住所の整形（都道府県、市区町村、番地、建物名で改行、5文字以上の場合も改行）
    function formatAddress(row) {
      const parts = [
        row.prefecture || '',
        row.city || '',
        row.address || '',
        row.building || ''
      ].filter(p => p.trim() !== '');

      let html = '';
      parts.forEach(p => {
        // 5文字以上、または既に改行が入っている場合はそのまま改行
        const shouldBreak = p.length >= 5 || html !== ''; 
        if(shouldBreak) html += '<br>';
        html += p;
      });
      return html.trim() || '-';
    }

    // 電話番号の整形（3-4-4で改行）
    function formatPhone(phone) {
      if (!phone) return '-';
      const clean = phone.replace(/\D/g, ''); // 数字のみ抽出
      if (clean.length === 10) { // 例: 08012345678 (11桁の場合) → 11桁に修正
         return clean.slice(0,3) + '<br>' + clean.slice(3,7) + '<br>' + clean.slice(7,11);
      }
      if (clean.length === 11) { // 11桁の場合
         return clean.slice(0,3) + '<br>' + clean.slice(3,7) + '<br>' + clean.slice(7,11);
      }
      return clean.replace(/-/g, '<br>'); // その他の場合（ハイフンが入っていたら改行に変換）
    }

    // 日付の整形（年と月日で2行、時間は不要）
    function formatDateTwoLines(dateString) {
      if (!dateString) return '-';
      const dt = new Date(dateString);
      if (isNaN(dt.getTime())) return '-';
      const year = dt.getFullYear();
      const monthDay = `${String(dt.getMonth()+1).padStart(2,"0")}/${String(dt.getDate()).padStart(2,"0")}`;
      return `${year}<br>${monthDay}`;
    }

    // 配達希望時間の整形（1820 -> 18<br>20）
    function formatTimeSlot(timeSlot) {
      const clean = (timeSlot || "").replace(/\D/g, '');
      if (clean.length === 4) {
        return clean.slice(0, 2) + '<br>' + clean.slice(2, 4);
      }
      return timeSlot || '-';
    }

    // ===== 注文データ描画 =====
    async function loadOrders(){
      const res = await fetch("/api/orders");
      if (!res.ok) throw new Error("データ取得に失敗しました");
      ORDERS = await res.json();
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      ORDERS.forEach(row=>{
        const tr = document.createElement("tr");
        const fullName = `${row.last_name || ''}<br>${row.first_name || ''}`.trim();
        const addrHtml = formatAddress(row);
        const phoneHtml = formatPhone(row.phone);
        const deliveryDateHtml = formatDateTwoLines(row.delivery_date);
        const timeSlotHtml = formatTimeSlot(row.time_slot);
        const createdHtml = formatDateTwoLines(row.created_at);
        
        // 発送種別はAか0かだけ
        const shipType = row.slip_type === 'A' ? 'A' : '0';

        tr.innerHTML = `
          <td><input type="checkbox" class="row-check" data-id="${row.id}"></td>
          <td>${row.id}</td>
          <td>${fullName}</td>
          <td>${addrHtml}</td>
          <td>${phoneHtml}</td>
          <td>${deliveryDateHtml}</td>
          <td>${timeSlotHtml}</td>
          <td data-col="ship">-</td> <td>${createdHtml}</td>
          <td>
            <select class="ship-type" data-id="${row.id}">
              <option value="0" ${shipType === '0' ? 'selected' : ''}>0</option>
              <option value="A" ${shipType === 'A' ? 'selected' : ''}>A</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // (全選択ボタンがないため、全選択機能のリスナーは削除)

      // 出荷予定日プレビューを反映
      refreshShipPreview();
    }

    // 選択中のCSV項目ID配列 (変更なし)
    function getSelectedColumnIds() {
      return Array.from(document.querySelectorAll('#colsContainer input[type="checkbox"]:checked'))
        .map(cb => cb.dataset.id);
    }

    // 選択中の注文 + 発送種別 (変更なし)
    function getSelections() {
      const checkedIds = new Set(
        Array.from(document.querySelectorAll('.row-check:checked')).map(cb => Number(cb.dataset.id))
      );
      const mapShip = {};
      document.querySelectorAll('.ship-type').forEach(sel=>{
        mapShip[Number(sel.dataset.id)] = sel.value; // "0" or "A"
      });
      return Array.from(checkedIds).map(id => ({ id, slip_type: mapShip[id] || "0" }));
    }

    // ===== 変換ボタン：ネコポス / 発払い (変更なし) =====
    function setSelectedShipType(to){
      const ids = new Set(
        Array.from(document.querySelectorAll('.row-check:checked')).map(cb => Number(cb.dataset.id))
      );
      if (ids.size === 0){
        alert('対象行をチェックしてください。');
        return;
      }
      document.querySelectorAll('.ship-type').forEach(sel=>{
        const id = Number(sel.dataset.id);
        if (ids.has(id)) sel.value = to; // "A" or "0"
      });
    }
    document.getElementById('toNekoposBtn').addEventListener('click', ()=> setSelectedShipType('A'));
    document.getElementById('toHatsubaraiBtn').addEventListener('click', ()=> setSelectedShipType('0'));

    // ===== 出荷予定日：年ボタン & MMDD入力 (変更なし) =====
    document.getElementById('shipYearBtn').addEventListener('click', ()=>{
      const y = prompt('出荷予定年を4桁で入力してください', String(shipYear));
      if (!y) return;
      if (!/^\d{4}$/g.test(y)) { alert('4桁の年を入力してください'); return; }
      shipYear = Number(y);
      refreshShipPreview();
    });
    document.getElementById('shipMmdd').addEventListener('input', (e)=>{
      shipMmdd = e.target.value.replace(/\D/g,'').slice(0,4);
      e.target.value = shipMmdd;
      refreshShipPreview();
    });

    // ===== CSV: 選択行 (変更なし) =====
    async function downloadSelectedCsv() {
      const selections = getSelections();
      if (selections.length === 0) { alert("CSVにする行をチェックしてください。"); return; }
      const columns = getSelectedColumnIds();
      if (columns.length === 0) { alert("CSV項目を1つ以上選んでください。"); return; }

      const shipDate = getShipDateYmd(); // "YYYY/MM/DD" or ""
      try {
        const res = await fetch('/api/orders/csv', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ selections, columns, ship_date: shipDate })
        });
        if (!res.ok) {
          const e = await res.json().catch(()=>({}));
          throw new Error(e.detail || 'CSV生成に失敗しました');
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'orders_b2.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('CSV作成中にエラー: ' + err.message);
      }
    }
    document.getElementById("csvSelectedBtn").addEventListener("click", downloadSelectedCsv);

    // ===== CSV: 一括（全件） (変更なし) =====
    async function downloadAllCsv(){
      const shipDate = encodeURIComponent(getShipDateYmd() || "");
      const url = shipDate ? `/api/orders/csv?ship_date=${shipDate}` : `/api/orders/csv`;
      try{
        const res = await fetch(url);
        if (!res.ok) throw new Error('CSV生成に失敗しました');
        const blob = await res.blob();
        const link = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = link;
        a.download = 'orders_b2.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(link);
      }catch(e){
        console.error(e);
        alert('CSV作成中にエラー: ' + e.message);
      }
    }
    document.getElementById('csvAllBtn').addEventListener('click', downloadAllCsv);

    // ===== 初期表示 (変更なし) =====
    (async ()=>{
      try {
        await loadCsvHeaders();
        await loadOrders();
        // 初期プレビュー
        refreshShipPreview();
      } catch (e) {
        console.error("初期化エラー:", e);
        alert("初期化中にエラーが発生しました。");
      }
    })();
  </script>
</body>
</html>
