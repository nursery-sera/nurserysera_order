<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>nursery sera — 注文管理</title>
  <style>
    body{font-family:sans-serif;margin:40px;}
    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #ccc;padding:6px 10px;text-align:left;font-size:14px;vertical-align:top;}
    th{background:#eee;}
    button{margin:10px 0;padding:6px 14px;font-size:14px;cursor:pointer;}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 16px;}
    .cols-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:4px 14px;margin-top:8px;max-height:260px;overflow:auto;padding:8px;border:1px solid #ddd;border-radius:6px;background:#fafafa;}
    .muted{color:#666;font-size:12px;}
  </style>
</head>
<body>
  <h1>注文データ一覧</h1>

  <div class="controls">
    <button id="csvSelectedBtn">選択行をCSVダウンロード</button>
    <span class="muted">※「発送種別」は行ごとに選べます（A=ネコポス / 0=発払い）。</span>
  </div>

  <details id="colPicker">
    <summary>CSVに含める項目を選ぶ（サーバー定義と完全一致）</summary>
    <div id="colsContainer" class="cols-list"></div>
    <label style="display:block;margin-top:8px;">
      <input type="checkbox" id="checkAllCols"> すべて選択 / 解除
    </label>
  </details>

  <table id="ordersTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="checkAllRows"></th>
        <th>ID</th>
        <th>名前</th>
        <th>住所</th>
        <th>電話</th>
        <th>配達希望日</th>
        <th>配達希望時間</th>
        <th>登録日</th>
        <th>発送種別<br><span class="muted">A=ネコポス / 0=発払い</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    // ===== パスワードガード（既存のまま） =====
    (function(){
      const pass = sessionStorage.getItem('admin-pass') || prompt('パスワードを入力してください');
      if (pass !== 'kohakurira') {
        alert('不正アクセス検知：トップページに戻ります');
        location.href = '/';
      } else {
        sessionStorage.setItem('admin-pass', pass);
      }
    })();

    // ===== グローバル =====
    let ORDERS = [];
    let CSV_HEADERS = [];

    // ===== サーバ定義CSVヘッダを取得してチェック群を作成 =====
    async function loadCsvHeaders() {
      const res = await fetch('/api/orders/csv/headers');
      if (!res.ok) throw new Error('CSVヘッダ取得に失敗');
      CSV_HEADERS = await res.json(); // [{id,title},...]
      const box = document.querySelector('#colsContainer');
      box.innerHTML = '';
      CSV_HEADERS.forEach(h => {
        const id = `col-${h.id}`;
        const div = document.createElement('label');
        div.innerHTML = `<input type="checkbox" id="${id}" data-id="${h.id}" checked> ${h.title} <span class="muted">(${h.id})</span>`;
        box.appendChild(div);
      });
      document.getElementById('checkAllCols').addEventListener('change', e=>{
        const checked = e.target.checked;
        box.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = checked);
      });
    }

    // ===== 注文データを読み込む =====
    async function loadOrders(){
      const res = await fetch("/api/orders");
      if (!res.ok) throw new Error("データ取得に失敗しました");
      ORDERS = await res.json();
      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      ORDERS.forEach(row=>{
        const tr = document.createElement("tr");
        const fullName = `${row.last_name || ''} ${row.first_name || ''}`.trim();
        const addr = `${row.prefecture || ''}${row.city || ''}${row.address || ''}${row.building || ''}`;
        const deliveryDate = row.delivery_date ? new Date(row.delivery_date).toLocaleDateString() : "-";
        const timeSlot = row.time_slot || "-";
        const created = new Date(row.created_at).toLocaleString();
        tr.innerHTML = `
          <td><input type="checkbox" class="row-check" data-id="${row.id}"></td>
          <td>${row.id}</td>
          <td>${fullName}</td>
          <td>${addr}</td>
          <td>${row.phone || ''}</td>
          <td>${deliveryDate}</td>
          <td>${timeSlot}</td>
          <td>${created}</td>
          <td>
            <select class="ship-type" data-id="${row.id}">
              <option value="0">0（発払い/宅急便）</option>
              <option value="A">A（ネコポス）</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 全選択
      const all = document.getElementById('checkAllRows');
      all.addEventListener('change', e=>{
        const checked = e.target.checked;
        document.querySelectorAll('.row-check').forEach(cb => cb.checked = checked);
      });
    }

    // 選択中のCSV項目ID配列
    function getSelectedColumnIds() {
      return Array.from(document.querySelectorAll('#colsContainer input[type="checkbox"]:checked'))
        .map(cb => cb.dataset.id);
    }

    // 選択中の注文 + 発送種別
    function getSelections() {
      const checkedIds = new Set(
        Array.from(document.querySelectorAll('.row-check:checked')).map(cb => Number(cb.dataset.id))
      );
      const mapShip = {};
      document.querySelectorAll('.ship-type').forEach(sel=>{
        mapShip[Number(sel.dataset.id)] = sel.value; // "0" or "A"
      });
      return Array.from(checkedIds).map(id => ({ id, slip_type: mapShip[id] || "0" }));
    }

    // ===== CSV: 選択行のみ、選択項目のみ、行ごとの発送種別で出力 =====
    async function downloadSelectedCsv() {
      const selections = getSelections();
      if (selections.length === 0) {
        alert("CSVにする行をチェックしてください。");
        return;
      }
      const columns = getSelectedColumnIds();
      if (columns.length === 0) {
        alert("CSV項目を1つ以上選んでください。");
        return;
      }

      try {
        const res = await fetch('/api/orders/csv', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ selections, columns })
        });
        if (!res.ok) {
          const e = await res.json().catch(()=>({}));
          throw new Error(e.detail || 'CSV生成に失敗しました');
        }
        // Blob受け取り → ダウンロード
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'orders_b2.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('CSV作成中にエラー: ' + err.message);
      }
    }

    document.getElementById("csvSelectedBtn").addEventListener("click", downloadSelectedCsv);

    // 初期表示
    (async ()=>{
      try {
        await loadCsvHeaders();
        await loadOrders();
      } catch (e) {
        console.error("初期化エラー:", e);
        alert("初期化中にエラーが発生しました。");
      }
    })();
  </script>
</body>
</html>