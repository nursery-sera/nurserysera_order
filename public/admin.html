<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>nursery sera — 注文管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    /* ===== 表示を約50%に縮小（全体スケール） ===== */
    html, body { height: 100%; }
    body{
      font-family:sans-serif;
      margin:40px;
      transform: scale(0.5);
      transform-origin: top left;
      width: 200%; /* 縮小で狭く見えないよう実効幅を補正 */
    }

    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #ccc;padding:10px 12px;text-align:left;vertical-align:top;}
    th{background:#eee;font-size:16px;white-space:nowrap;word-break:keep-all;}
    td{font-size:18px;line-height:1.25;}

    button{
      margin:10px 0;padding:12px 16px;
      font-size:18px;min-height:56px;cursor:pointer;
      border-radius:10px;border:1px solid #bbb;background:#f7f7f7;
    }

    /* 横文字・改行なし（ネコポス／宅急便ボタン用） */
    .nowrap-btn {
      white-space: nowrap;
      word-break: keep-all;
      writing-mode: horizontal-tb;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      align-items:start;
      margin:8px 0 16px;
    }
    .col{display:flex;flex-direction:column;gap:6px;}

    .cols-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:4px 14px;margin-top:8px;max-height:260px;overflow:auto;padding:8px;border:1px solid #ddd;border-radius:6px;background:#fafafa;}
    .muted{color:#666;font-size:14px;white-space:pre-line;}
    .ship-preview{font-weight:bold;}

    input[type="text"]{padding:10px 12px;font-size:18px;border:1px solid #bbb;border-radius:10px;}

    .row-check{transform:scale(1.8);transform-origin:left top;margin:8px 0;}

    .hline{display:inline-block;white-space:nowrap;word-break:keep-all;}
    .center{text-align:center;}
  </style>
</head>
<body>
  <h1>注文データ一覧</h1>

  <!-- === 並び替え後のボタン群 === -->
  <div class="controls">
    <!-- 左：☑︎→CSV / allCSV -->
    <div class="col">
      <button id="csvSelectedBtn">☑︎→CSV</button>
      <button id="csvAllBtn">一括CSV</button>
    </div>

    <!-- 中：☑︎→ネコポス / ☑︎→宅急便 -->
    <div class="col">
      <button id="toNekoposBtn" class="nowrap-btn">☑︎→Aネコポス</button>
      <button id="toHatsubaraiBtn" class="nowrap-btn">☑︎→0宅急便</button>
    </div>

    <!-- 右：2025 / 出荷予定日：［入力］ → 未設定 -->
    <div class="col">
      <button id="shipYearBtn" title="クリックで年を変更">2025</button>
      <div>
        <label>出荷予定日：<input type="text" id="shipMmdd" placeholder="例: 12月25日→1225" maxlength="4" inputmode="numeric" pattern="[0-9]*"></label>
        <span> <span id="shipPreview" class="ship-preview"></span></span>
      </div>
    </div>
  </div>

  <details id="colPicker">
    <summary>CSVに含める項目を選ぶ</summary>
    <div id="colsContainer" class="cols-list"></div>
    <label style="display:block;margin-top:8px;">
      <input type="checkbox" id="checkAllCols"> すべて選択 / 解除
    </label>
  </details>

  <table id="ordersTable">
    <thead>
      <tr>
        <!-- ご指定の順番：選択, 発送種別, 出荷予定日, 名前, 住所, 電話, 配達希望日, 配達希望時間, 登録日 -->
        <th>選択</th>
        <th>発送種別</th>
        <th>出荷予定日</th>
        <th>名前</th>
        <th>住所</th>
        <th>電話</th>
        <th>配達希望日</th>
        <th>配達希望時間</th>
        <th>登録日</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    // ===== パスワードガード（既存） =====
    (function(){
      const pass = sessionStorage.getItem('admin-pass') || prompt('パスワードを入力してください');
      if (pass !== 'kohakurira') { alert('不正アクセス検知：トップページに戻ります'); location.href = '/'; }
      else { sessionStorage.setItem('admin-pass', pass); }
    })();

    // ===== グローバル =====
    let ORDERS = [];
    let CSV_HEADERS = [];
    let shipYear = new Date().getFullYear();
    let shipMmdd = "";

    const esc = s => String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const onlyDigits = s => (s||"").replace(/\D/g,"");

    // 5文字超のときのみ強制改行（横書き維持）
    function brIfLongEveryN(str, n=5){
      const s = String(str||"");
      if (!s) return "";
      if (s.length <= n) return `<span class="hline">${esc(s)}</span>`;
      const parts = [];
      for(let i=0;i<s.length;i+=n) parts.push(`<span class="hline">${esc(s.slice(i,i+n))}</span>`);
      return parts.join("<br>");
    }
    // 名前：姓 ↵ 名
    function formatName(last, first){
      const l = (last||"").trim();
      const f = (first||"").trim();
      if (!l && !f) return "-";
      return `<span class="hline">${esc(l)}</span><br><span class="hline">${esc(f)}</span>`;
    }
    // 住所
    function formatAddress(pref, city, addr, bld){
      return [pref, city, addr, bld]
        .map(part => part ? brIfLongEveryN(part, 5) : "")
        .filter(Boolean)
        .join("<br>");
    }
    // 電話：3/4/4
    function formatPhone(phone){
      const d = onlyDigits(phone);
      if (!d) return "-";
      const a = d.slice(0,3), b = d.slice(3,7), c = d.slice(7,11);
      return [a,b,c].filter(Boolean).map(x=>`<span class="hline">${esc(x)}</span>`).join("<br>");
    }
    // 日付：YYYY ↵ MM/DD
    function toYAndMdHtml(dateLike){
      if (!dateLike) return "-";
      const dt = new Date(dateLike);
      if (isNaN(dt)) return "-";
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const d = String(dt.getDate()).padStart(2,"0");
      return `<span class="hline">${y}</span><br><span class="hline">${m}/${d}</span>`;
    }
    // 時間帯：1820 → 18 ↵ 20
    function formatTimeSlotHtml(slot){
      if (!slot) return "-";
      const s = String(slot).replace(/\D/g,"");
      if (s.length===4) return `<span class="hline">${esc(s.slice(0,2))}</span><br><span class="hline">${esc(s.slice(2,4))}</span>`;
      return `<span class="hline">${esc(s)}</span>`;
    }
    // MMDD -> YYYY/MM/DD
    function mmddToYmd(year, mmdd){
      const m = (mmdd || "").trim();
      if (!/^\d{4}$/.test(m)) return "";
      const MM = m.slice(0,2), DD = m.slice(2,4);
      const dt = new Date(`${year}/${MM}/${DD}`);
      if (isNaN(dt.getTime())) return "";
      const y = dt.getFullYear();
      const M = String(dt.getMonth()+1).padStart(2,"0");
      const D = String(dt.getDate()).padStart(2,"0");
      return `${y}/${M}/${D}`;
    }
    function getShipDateYmd(){ return mmddToYmd(shipYear, shipMmdd); }

    // 出荷予定日の見た目更新（テーブル列）
    function refreshShipPreview(){
      document.getElementById('shipYearBtn').textContent = String(shipYear);
      const ymd = getShipDateYmd();
      document.getElementById('shipPreview').textContent = ymd || "";
      const html = ymd ? `<span class="hline">${ymd.split("/")[0]}</span><br><span class="hline">${ymd.slice(5)}</span>` : "-";
      document.querySelectorAll('td[data-col="ship"]').forEach(td=> td.innerHTML = html);
    }

    // CSVヘッダ（既存）
    async function loadCsvHeaders() {
      const res = await fetch('/api/orders/csv/headers');
      if (!res.ok) throw new Error('CSVヘッダ取得に失敗');
      CSV_HEADERS = await res.json();
      const box = document.querySelector('#colsContainer');
      box.innerHTML = '';
      CSV_HEADERS.forEach(h => {
        const id = `col-${h.id}`;
        const div = document.createElement('label');
        div.innerHTML = `<input type="checkbox" id="${id}" data-id="${h.id}" checked> ${h.title} <span class="muted">(${h.id})</span>`;
        box.appendChild(div);
      });
      document.getElementById('checkAllCols').addEventListener('change', e=>{
        const checked = e.target.checked;
        box.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = checked);
      });
    }

    // 注文データの描画（列順のみ変更）
    async function loadOrders(){
      const res = await fetch("/api/orders");
      if (!res.ok) throw new Error("データ取得に失敗しました");
      ORDERS = await res.json();

      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";
      ORDERS.forEach(row=>{
        const tr = document.createElement("tr");

        const nameHtml = formatName(row.last_name, row.first_name);
        const addrHtml = formatAddress(row.prefecture||'', row.city||'', row.address||'', row.building||'') || "-";
        const phoneHtml = formatPhone(row.phone||'') || "-";
        const delivHtml = row.delivery_date ? toYAndMdHtml(row.delivery_date) : "-";
        const timeHtml  = formatTimeSlotHtml(row.time_slot||"") || "-";
        const createdHtml = row.created_at ? toYAndMdHtml(row.created_at) : "-";

        tr.innerHTML = `
          <!-- 選択 -->
          <td class="center"><input type="checkbox" class="row-check" data-id="${row.id}"></td>

          <!-- 発送種別（セレクトはそのまま） -->
          <td class="center">
            <select class="ship-type" data-id="${row.id}" style="font-size:18px;min-height:48px;">
              <option value="0">0</option>
              <option value="A">A</option>
            </select>
          </td>

          <!-- 出荷予定日（プレビューは右上の設定に追随） -->
          <td class="center" data-col="ship">-</td>

          <!-- 名前 -->
          <td class="center">${nameHtml}</td>

          <!-- 住所 -->
          <td>${addrHtml}</td>

          <!-- 電話 -->
          <td class="center">${phoneHtml}</td>

          <!-- 配達希望日 -->
          <td class="center">${delivHtml}</td>

          <!-- 配達希望時間 -->
          <td class="center">${timeHtml}</td>

          <!-- 登録日 -->
          <td class="center">${createdHtml}</td>
        `;
        tbody.appendChild(tr);
      });

      refreshShipPreview();
    }

    // 変換ボタン
    function setSelectedShipType(to){
      const ids = new Set(
        Array.from(document.querySelectorAll('.row-check:checked')).map(cb => Number(cb.dataset.id))
      );
      if (ids.size === 0){ alert('対象行をチェックしてください。'); return; }
      document.querySelectorAll('.ship-type').forEach(sel=>{
        const id = Number(sel.dataset.id);
        if (ids.has(id)) sel.value = to;
      });
    }
    document.getElementById('toNekoposBtn').addEventListener('click', ()=> setSelectedShipType('A'));
    document.getElementById('toHatsubaraiBtn').addEventListener('click', ()=> setSelectedShipType('0'));

    // 出荷予定日入力
    document.getElementById('shipYearBtn').addEventListener('click', ()=>{
      const y = prompt('出荷予定年を4桁で入力してください', String(shipYear));
      if (!y) return;
      if (!/^\d{4}$/.test(y)) { alert('4桁の年を入力してください'); return; }
      shipYear = Number(y);
      refreshShipPreview();
    });
    document.getElementById('shipMmdd').addEventListener('input', (e)=>{
      shipMmdd = e.target.value.replace(/\D/g,'').slice(0,4);
      e.target.value = shipMmdd;
      refreshShipPreview();
    });

    // CSV用ユーティリティ
    function getSelectedColumnIds() {
      return Array.from(document.querySelectorAll('#colsContainer input[type="checkbox"]:checked'))
        .map(cb => cb.dataset.id);
    }
    function getSelections() {
      const checkedIds = new Set(
        Array.from(document.querySelectorAll('.row-check:checked')).map(cb => Number(cb.dataset.id))
      );
      const mapShip = {};
      document.querySelectorAll('.ship-type').forEach(sel=>{
        mapShip[Number(sel.dataset.id)] = sel.value;
      });
      return Array.from(checkedIds).map(id => ({ id, slip_type: mapShip[id] || "0" }));
    }

    // === バリデーション追加：出荷予定日未設定ならCSV出力不可 ===
    async function downloadSelectedCsv() {
      const selections = getSelections();
      if (selections.length === 0) { alert("CSVにする行をチェックしてください。"); return; }
      const columns = getSelectedColumnIds();
      if (columns.length === 0) { alert("CSV項目を1つ以上選んでください。"); return; }

      const shipDate = getShipDateYmd();
      if (!shipDate) { alert("出荷予定日を設定してください（年ボタン＋MMDD入力）。"); return; }

      try {
        const res = await fetch('/api/orders/csv', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ selections, columns, ship_date: shipDate })
        });
        if (!res.ok) {
          const e = await res.json().catch(()=>({}));
          throw new Error(e.detail || 'CSV生成に失敗しました');
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'orders_b2.csv';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('CSV作成中にエラー: ' + err.message);
      }
    }
    document.getElementById("csvSelectedBtn").addEventListener("click", downloadSelectedCsv);

    async function downloadAllCsv(){
      const shipDate = getShipDateYmd();
      if (!shipDate) { alert("出荷予定日を設定してください（年ボタン＋MMDD入力）。"); return; }

      const url = `/api/orders/csv?ship_date=${encodeURIComponent(shipDate)}`;
      try{
        const res = await fetch(url);
        if (!res.ok) throw new Error('CSV生成に失敗しました');
        const blob = await res.blob();
        const link = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = link; a.download = 'orders_b2.csv';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(link);
      }catch(e){
        console.error(e);
        alert('CSV作成中にエラー: ' + e.message);
      }
    }
    document.getElementById('csvAllBtn').addEventListener('click', downloadAllCsv);

    // 初期表示
    (async ()=>{
      try {
        await loadCsvHeaders();
        await loadOrders();
        refreshShipPreview();
      } catch (e) {
        console.error("初期化エラー:", e);
        alert("初期化中にエラーが発生しました。");
      }
    })();
  </script>
</body>
</html>