<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <script>window.API_BASE='https://www.nurserysera.com/api';</script>
  <meta name="viewport" content="width=950, user-scalable=no">
  <title>nursery sera — ご注文フォーム</title>
  <link href="https://fonts.googleapis.com/css2?family=Bayon&family=Tangerine:wght@700&family=Italianno&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;padding:0;font-size:20px;-webkit-text-size-adjust:100%;font-family:Arial,sans-serif;background:#fff;color:#333;box-sizing:border-box;min-height:100vh;scroll-behavior:smooth}
    *,*:before,*:after{box-sizing:inherit}

    /* ===== ヘッダー（上部固定／線なし／スクロール追従なし） ===== */
    .header-bar{
      position:relative;
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      padding:20px; border:none; box-shadow:none; outline:0;
    }
    .main-title{font-family:'Bayon',cursive;font-size:120px;margin:0;white-space:nowrap;user-select:none}

    /* 見出し */
    .subtitle-x{font-family:'Tangerine',cursive;font-size:100px;opacity:.6;margin-top:-30px;text-align:center;color:#555}
    .subtitle{font-family:'Tangerine',cursive;font-size:44px;opacity:1;margin:66px 0 -10px;text-align:center;color:#888;font-weight:300}

    /* 入力フォーム */
    form{width:100vw;padding:0 5vw}
    .form-group{position:relative;margin-top:48px}
    .form-group input,.form-group textarea,.form-group select{
      width:100%; padding:28px 12px 12px 12px; font-size:42px;
      border:none; border-bottom:2px solid #aaa; background:transparent; outline:none;
      font-weight:300; appearance:none; color:inherit; text-align:left; line-height:1.2;
    }
    .form-group textarea{min-height:6em;resize:vertical}

    /* 日付入力：他と完全統一＋青文字抑制 */
    input[type="date"]{
      -webkit-appearance:none; appearance:none;
      color:inherit; -webkit-text-fill-color:currentColor; font-weight:300;
      text-align:left; font-size:42px; line-height:inherit; padding:28px 12px 12px 12px;
      background:transparent;
    }
    input[type="date"]::-webkit-datetime-edit{color:inherit;padding:0;text-align:left}
    input[type="date"]::-webkit-date-and-time-value{text-align:left}
    input[type="date"]::-webkit-clear-button{display:none}
    input[type="date"]::-webkit-calendar-picker-indicator{opacity:.6}

    /* 選択肢の青色強制を抑える */
    select option{color:#333}
    select:focus, input[type="date"]:focus{color:inherit;-webkit-text-fill-color:currentColor}

    .form-group label{
      position:absolute; left:12px; top:22px; color:#888; background:inherit; padding:0 6px;
      transition:.2s ease; pointer-events:none; font-size:36px;
    }
    /* ラベル浮上（select/date は .has-value で補助） */
    .form-group input:focus + label,
    .form-group input:not(:placeholder-shown) + label,
    .form-group textarea:focus + label,
    .form-group textarea:not(:placeholder-shown) + label,
    .form-group select.has-value + label,
    .form-group select:focus + label,
    .form-group input[type="date"].has-value + label,
    .form-group input[type="date"]:focus + label{
      top:-16px; left:8px; font-size:28px; color:#444;
    }

    input::placeholder{opacity:0;transition:opacity .2s}
    input:focus::placeholder{opacity:1}
    .ph-on::placeholder{opacity:1!important}

    .row{display:flex;gap:16px}
    .row .form-group{flex:1;margin-top:48px}

    .zip-btn{opacity:.9;position:absolute;right:0;top:0;height:100%;font-size:36px;padding:0 20px;background:#fff;color:#888;border:2px solid #888;cursor:pointer;border-radius:0;font-weight:400;transform:translate(0,-2px)}

    .pref-wrap{position:relative}
    .pref-list{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid #aaa;z-index:9999;max-height:280px;overflow:auto;display:none}
    .pref-list button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:12px;font-size:32px;cursor:pointer;border-bottom:1px solid #eee}
    .pref-list button:hover{background:#f7f7f7}

    .submit-button{
      display:block;width:fit-content;margin:50px auto 120px;background:none;border:none;padding:0;font-size:52px;font-weight:200;color:#333;cursor:pointer;opacity:.8;
      text-decoration:none;border-bottom:1.4px solid currentColor;padding-bottom:6px
    }

    @media (min-width:1024px)){
      html{font-size:16px}
      .main-title{font-size:100px}
      .subtitle{font-size:20px}
      form{max-width:720px;margin:0 auto;padding:0 32px}
      .form-group input,.form-group textarea,.form-group select{font-size:16px;padding:12px 10px}
      .form-group label{font-size:14px;top:14px}
      .form-group input:focus + label,
      .form-group input:not(:placeholder-shown) + label,
      .form-group textarea:focus + label,
      .form-group textarea:not(:placeholder-shown) + label,
      .form-group select.has-value + label,
      .form-group select:focus + label,
      .form-group input[type="date"].has-value + label,
      .form-group input[type="date"]:focus + label{font-size:12px;top:-10px}
      .zip-btn{font-size:14px;padding:0 14px}
      .pref-list button{font-size:14px}
    }
  </style>
</head>
<body>
  <!-- 上部に固定配置（スクロールで流れる）／線なし -->
  <div class="header-bar" id="titleBar" aria-label="nursery sera">
    <div class="main-title">nursery sera</div>
  </div>

  <p class="subtitle-x">order form</p>
  <p class="subtitle">配送先住所</p>

  <form id="contact-form">
    <div class="row">
      <div class="form-group">
        <input id="lastName" name="lastName" type="text" placeholder="お名前" autocomplete="family-name" required>
        <label id="nameMasterLabel">お名前</label>
      </div>
      <div class="form-group">
        <input id="firstName" name="firstName" type="text" placeholder="" autocomplete="given-name" required>
        <label></label>
      </div>
    </div>

    <!-- フリガナ欄は削除 -->

    <div class="form-group">
      <input type="text" id="zipcode" name="zipcode" placeholder="例:1234567(ハイフンなし)" maxlength="7" required>
      <label>郵便番号</label>
      <button type="button" class="zip-btn" id="zipBtn">住所自動入力</button>
    </div>

    <div class="form-group pref-wrap">
      <input type="text" id="prefecture" name="prefecture" placeholder=" " required readonly>
      <label>都道府県</label>
      <div class="pref-list" id="prefList"></div>
    </div>

    <div class="form-group">
      <input type="text" id="city" name="city" placeholder=" " required>
      <label>市区町村</label>
    </div>

    <div class="form-group">
      <input type="text" id="address" name="address" placeholder=" ">
      <label>町名・番地</label>
    </div>

    <div class="form-group">
      <input type="text" id="building" name="building" placeholder=" ">
      <label>建物名・部屋番号</label>
    </div>

    <div class="form-group">
      <input type="tel" id="phone" name="phone" placeholder=" " required>
      <label>電話番号（ハイフンなし）</label>
    </div>

    <!-- メール：任意 -->
    <div class="form-group">
      <input type="email" id="email" name="email" placeholder=" " autocomplete="email">
      <label>連絡用メールアドレス（任意）</label>
    </div>

    <!-- Instagramアカウント名（任意） -->
    <div class="form-group">
      <input type="text" id="instagram" name="instagram" placeholder=" ">
      <label>Instagramからご注文の方:アカウント名</label>
    </div>

    <!-- お届け希望日（3〜14日後のみ選択可／未選択＝最短） -->
    <div class="form-group">
      <input type="date" id="deliveryDate" name="deliveryDate" placeholder=" ">
      <label>お届け希望日（3〜14日後で指定可／未選択＝最短）</label>
    </div>

    <!-- ご希望配達時間（任意） -->
    <div class="form-group">
      <select id="timeSlot" name="timeSlot">
        <option value="" selected hidden></option>
        <option value="08-12">午前中</option>
        <option value="14-16">14時～16時</option>
        <option value="16-18">16時～18時</option>
        <option value="18-20">18時～20時</option>
        <option value="19-21">19時～21時</option>
      </select>
      <label>ご希望配達時間（任意）</label>
    </div>

    <div class="form-group">
      <textarea id="memo" name="memo" placeholder=" "></textarea>
      <label>備考【任意】</label>
    </div>

    <button type="submit" id="submitBtn" class="submit-button" aria-busy="false">送信 ></button>
  </form>

<script>
  /* ==== select / date のラベル状態（値あり→.has-value） ==== */
  (function(){
    function bindHasValue(el){
      if(!el) return;
      const apply=()=>{ el.classList[el.value ? 'add' : 'remove']('has-value'); };
      el.addEventListener('change',apply);
      el.addEventListener('blur',apply);
      apply();
    }
    bindHasValue(document.getElementById('timeSlot'));
    bindHasValue(document.getElementById('deliveryDate'));
  })();

  /* ==== お届け希望日：min=3日後, max=14日後 + ブラックアウト ==== */
  (function(){
    const el = document.getElementById('deliveryDate');
    if(!el) return;

    // ▼ここに選べない特定日を列挙（例）
    const BLACKOUTS = [
      // '2025-01-01','2025-01-02'
    ];
    // ▼週次店休日（0=日 … 6=土）。例：日曜休みなら [0]
    const WEEKLY_CLOSED = [
      // 0
    ];

    const toYMD = (d)=>[
      d.getFullYear(),
      String(d.getMonth()+1).padStart(2,'0'),
      String(d.getDate()).padStart(2,'0')
    ].join('-');

    const today = new Date();
    const minD = new Date(today); minD.setDate(minD.getDate()+3);
    const maxD = new Date(today); maxD.setDate(maxD.getDate()+14);

    el.min = toYMD(minD);
    el.max = toYMD(maxD);

    function isWeeklyClosed(d){ return WEEKLY_CLOSED.includes(d.getDay()); }
    function isBlackout(d){ return BLACKOUTS.includes(toYMD(d)); }
    function isOutOfRange(d){ return d < minD || d > maxD; }
    function isDisabled(d){ return isOutOfRange(d) || isWeeklyClosed(d) || isBlackout(d); }

    // ピッカーで選ばれても無効日なら即リセット
    el.addEventListener('input', ()=>{
      if (!el.value) return;
      const d = new Date(el.value+'T00:00:00');
      if (isDisabled(d)){
        const msg =
          isOutOfRange(d) ? '選択できるのは3〜14日後です。' :
          isWeeklyClosed(d) ? '店休日のため選択できません。' :
          'この日は選択できません。';
        el.setCustomValidity(msg);
        alert(msg);
        el.value = '';
        el.classList.remove('has-value');
      } else {
        el.setCustomValidity('');
        el.classList.add('has-value');
      }
    });

    // 補助表示：範囲内の「選べない日」一覧を下に表示
    const help = document.createElement('div');
    help.style.fontSize = '14px';
    help.style.color = '#888';
    help.style.marginTop = '6px';

    const list = [];
    const tmp = new Date(minD);
    while (tmp <= maxD){
      if (isDisabled(tmp)) list.push(toYMD(tmp));
      tmp.setDate(tmp.getDate()+1);
    }
    if (list.length){
      help.textContent = '選べない日: ' + list.join(', ');
      el.parentElement.appendChild(help);
    }
  })();

  /* ====== 郵便番号 → 住所 ====== */
  (function(){
    var prefInput=document.getElementById('prefecture');
    var prefList=document.getElementById('prefList');
    var zipBtn=document.getElementById('zipBtn');

    function setPrefecture(p){ if(prefInput) prefInput.value=p; }
    window.setPrefecture=setPrefecture;

    if(zipBtn){
      zipBtn.addEventListener('click',function(){
        var zipEl=document.getElementById('zipcode');
        var zip=(zipEl&&zipEl.value?zipEl.value:'').trim();
        if(!/^\d{7}$/.test(zip)){ alert('正しい7桁の郵便番号を入力してください'); return; }
        fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode='+zip)
          .then(function(r){ return r.json(); })
          .then(function(data){
            if(!data.results){ alert('住所が見つかりませんでした。'); return; }
            var r=data.results[0];
            setPrefecture(r.address1);
            var city=document.getElementById('city');
            var addr=document.getElementById('address');
            if(city) city.value=(r.address2||'');
            if(addr) addr.value=(r.address3||'');
          })
          .catch(function(){ alert('検索エラー'); });
      });
    }

    var prefInput2=document.getElementById('prefecture');
    var prefList2=document.getElementById('prefList');
    var PREFS=["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];
    if(prefInput2&&prefList2){
      PREFS.forEach(function(p){
        var b=document.createElement('button'); b.type='button'; b.textContent=p;
        b.addEventListener('click',function(){ setPrefecture(p); hidePrefList(); });
        prefList2.appendChild(b);
      });
      function showPrefList(){ prefList2.style.display='block'; }
      function hidePrefList(){ prefList2.style.display='none'; }
      prefInput2.addEventListener('click',function(e){ e.stopPropagation(); (prefList2.style.display==='block'?hidePrefList():showPrefList()); });
      document.addEventListener('click',hidePrefList);
    }
  })();

  /* ====== 送信（APIへPOST） ====== */
  (function(){
    const API=(window.API_BASE||'')+'/orders';
    let submitting=false;
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    async function postJsonWithTimeout(url,body,{timeoutMs=20000}={}){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(new Error('timeout')),timeoutMs);
      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(body),cache:'no-store',keepalive:true,signal:ctrl.signal});
        const text=await res.text(); let data; try{ data=text?JSON.parse(text):null; }catch{ data={raw:text}; } return {ok:res.ok,status:res.status,data};
      } finally{ clearTimeout(t); }
    }
    function sanitize(str){ return String(str||'').replace(/\p{Cf}/gu,'').trim(); }

    var form=document.getElementById('contact-form'); if(!form) return;
    const submitBtn=document.getElementById('submitBtn');
    submitBtn?.addEventListener('click',e=>{ if(submitBtn.getAttribute('aria-busy')==='true') e.preventDefault(); });

    form.addEventListener('submit',async function(e){
      e.preventDefault(); if(submitting) return; submitting=true;
      const fd=new FormData(form);

      if(submitBtn){ submitBtn.textContent='送信中…'; submitBtn.setAttribute('aria-busy','true'); submitBtn.disabled=true; }
      const disabledEls=[]; form.querySelectorAll('input,textarea,button,select').forEach(el=>{ if(!el.disabled){ el.disabled=true; disabledEls.push(el);} });

      const emailRaw=sanitize(fd.get('email'));
      const emailOk=!emailRaw || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailRaw); // 任意：空はOK

      const deliveryDateRaw=sanitize(fd.get('deliveryDate')); const deliveryDate=deliveryDateRaw||''; // ''=最短

      const customer={
        lastName:sanitize(fd.get('lastName')), firstName:sanitize(fd.get('firstName')),
        zipcode:sanitize(fd.get('zipcode')), prefecture:sanitize(fd.get('prefecture')),
        city:sanitize(fd.get('city')), address:sanitize(fd.get('address')), building:sanitize(fd.get('building')),
        phone:sanitize(fd.get('phone')), email:emailRaw||'',
        instagram:sanitize(fd.get('instagram')),
        name:(sanitize(fd.get('lastName'))+' '+sanitize(fd.get('firstName'))).trim(),
        addressFull:(sanitize(fd.get('prefecture'))+sanitize(fd.get('city'))+sanitize(fd.get('address'))+sanitize(fd.get('building'))).trim()
      };

      if(!emailOk){ alert('メールアドレスの形式が正しくありません'); cleanup(); return; }
      if(!customer.lastName||!customer.firstName){ alert('お名前（姓・名）を入力してください'); cleanup(); return; }

      const cart=JSON.parse(localStorage.getItem('cart')||'[]');
      const items=cart.map(it=>{
        const raw=it.productId??it.id??null; const numericId=/^\d+$/.test(String(raw))?Number(raw):null;
        return { productId:numericId, productName:String(it.productName??it.variety??it.name??''), unitPrice:Number(it.price||0), quantity:Number(it.quantity||1), productSlug:String(raw||''), image:(it.image||'').split('?')[0].slice(0,512), category:String(it.category||''), variety:String(it.variety||'') };
      });

      const checkout=JSON.parse(localStorage.getItem('checkout')||'null');
      const subtotal=items.reduce((s,it)=>s+it.unitPrice*it.quantity,0);
      const shipping=Number(checkout?.shippingCost??0);
      const shippingOptionText=String(checkout?.shippingName||'');
      const paymentMethod=(checkout&&checkout.paymentMethod)||'bank_transfer';
      const total=Number(checkout?.total??(subtotal+shipping));

      const payload={
        customer, note:sanitize(fd.get('memo')), items,
        summary:{ subtotal, shipping, shippingOptionText, total, paymentMethod },
        delivery:{ desired_date:deliveryDate, desired_time:sanitize(fd.get('timeSlot')) }
      };

      try{
        let r=await postJsonWithTimeout(API,payload,{timeoutMs:20000});
        if((!r.ok&&[502,504].includes(r.status))||(r.data&&r.data.code===502)){ await sleep(1200); r=await postJsonWithTimeout(API,payload,{timeoutMs:20000}); }
        if(!r.ok){ const msg=r.data?.message||r.data?.error||r.data?.raw||'サーバーエラー'; const reqId=r.data?.request_id?`\nrequest_id: ${r.data.request_id}`:''; throw new Error(`HTTP ${r.status}: ${msg}${reqId}`); }
        window.__orderSubmitSucceeded__=true;
        alert('送信が完了しました。ご注文ありがとうございます。');  // 自動返信の案内は削除
        localStorage.removeItem('cart'); localStorage.removeItem('checkout'); e.target.reset();
        document.getElementById('timeSlot')?.classList.remove('has-value');
        document.getElementById('deliveryDate')?.classList.remove('has-value');
      }catch(err){
        alert(`エラー：${err.message}\n\n送信先: ${API}`); console.error('order error',err);
      }finally{ cleanup(); }

      function cleanup(){
        if(submitBtn){ submitBtn.textContent='送信 >'; submitBtn.setAttribute('aria-busy','false'); submitBtn.disabled=false; }
        form.querySelectorAll('input,textarea,button,select').forEach(el=>{ el.disabled=false; });
        if(!window.__orderSubmitSucceeded__) submitting=false;
      }
    });
  })();
</script>
</body>
</html>
